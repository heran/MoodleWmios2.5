//Update notes
$(function(){
    var noteModInfo = {cmid:0,courseid:$('body').attr('courseid')};
    var inModview = false;
    var refreshNoteList = function(boxId,cmid,courseid,position){
        var url = $('#'+boxId).attr('url');
        if(url){
            $.get(url,{cmid:cmid,courseid:courseid,position:position},function(data){
                var results = $.parseJSON(data);
                if(results.status){
                    $('#'+boxId).html('');
                    $.each(results.list,function(i,n){
                        var cmInfo = '';
                        var modname = '';
                        if(n.cmid-0>0 && !inModview){
                            var cm = results.cms[n.cmid];
                            cmInfo = '<br /><a class="display-by-cmid" cmid="'+cm.id+'" >'+cm.name+'</a>';
                            modname =  'modname="'+cm.modname+'"';
                        }
                        $('#'+boxId).append(
                            '<li note_id="'+n.id+'">'+
                            '<div class="bullet goto-and-play-mod" '+modname+' position="'+n.position+'" cmid="'+n.cmid+'">'+n.position_str+cmInfo+'</div>'+
                            '<p class="ud-inplaceeditor">'+
                            '<span>'+n.text.replace(new RegExp("\r\n","g"),"<br />")
                            .replace(new RegExp("\n","g"),"<br />")
                            .replace(new RegExp("\r","g"),"<br />")+'</span>'+
                            '<span class="inplaceeditor-delete none">Ã—</span>'+
                            '</p>'+
                            '</li>');
                    });
                }
            });
        }
    }
    
    //First Refresh
    refreshNoteList('notes-list',0,$('body').attr('courseid'),0);
    $(document).on('keypress','.note-input',function(e){
        if(e.which == 10 && e.ctrlKey){
            var url = $(this).parent('form').attr('action');
            var postData = noteModInfo;
            postData.text = $(this).val();
            postData.courseid = $('body').attr('courseid');
            var texta = this;
            if(inModview){
                if(typeof window.getModPosition != 'undefined'){
                    postData.position = window.getModPosition();
                }
            }
            $.post(url,postData,function(data){
                var result = $.parseJSON(data);
                if(result.status){
                    $(texta).val('');
                    refreshNoteList(
                        $(texta).parents('form').parent().find('.notes-list-box').attr('id'),
                        postData.cmid
                        ,$('body').attr('courseid'),
                        0);
                }                    
            });
        }
    })
    .on('modviewOpen',function(e,modInfo){
        noteModInfo.cmid = modInfo.cmid;
        inModview = true;
        
        $('.notes-list-box').html('');
        var blockHtml = $('.block_notes.block>.content').html();
        $('.block_notes.block>.content').html('');
        $('.ud-coursetaking.wrapper .notes-placeholder').replaceWith(blockHtml);
        
        
        
        refreshNoteList('notes-list',modInfo.cmid,$('body').attr('courseid'),0);

    })
    .on('modviewClose',function(){
        noteModInfo.cmid = 0;
        inModview = false;
        
        $('.notes-list-box').html('');        
        var blockNode = $('.ud-coursetaking.wrapper #notes').clone();
        $('.ud-coursetaking.wrapper #notes').replaceWith('<div class="notes-placeholder"></div>');
        $('.block_notes.block>.content').append(blockNode);        
        
        refreshNoteList('notes-list',0,$('body').attr('courseid'),0);
    })
    .on('click','.ud-inplaceeditor',function(){
        var p = this;

        if($(this).find('textarea').length>0){
            return;
        }

        var deleteButton = $($(this).find('span').get(1)).clone();            
        var oldHtmlNode = $($(this).find('span').get(0)).clone();
        var oldHtml = $(oldHtmlNode).html();
        var width = $(this).width();
        var height = $(this).height();
        $(this).html('<textarea>'+oldHtml.replace(new RegExp("<br />","g"),"\n").replace(new RegExp("<br>","g"),"\n")+'</textarea>');
        var textarea = $(this).find('textarea');
        $(textarea).width(width);
        $(textarea).height(height);
        $(textarea).focus();
        $(textarea).focusout(function(){
            var newHtml = $(this).val().replace(new RegExp("\r\n","g"),"<br />")
            .replace(new RegExp("\n","g"),"<br />")
            .replace(new RegExp("\r","g"),"<br />");
            $(oldHtmlNode).html(newHtml);
            var note_id = $(this).parents('li').attr('note_id');
            var url = $(this).parents('.ud-notes-box').find('form').attr('action');
            $.post(url,{note_id:note_id,courseid:$('body').attr('courseid'),text:$(this).val()},function(){                    
            });
            $(p).html('').append(oldHtmlNode).append(deleteButton);                
        });
    })
    .on('mouseover','.ud-inplaceeditor',function(){
        $(this).find('.inplaceeditor-delete').removeClass('none');
    })
    .on('mouseout','.ud-inplaceeditor',function(){
        $(this).find('.inplaceeditor-delete').addClass('none');
    })
    .on('click','.inplaceeditor-delete',function(){
        var url = $('.notes-list-box').attr('delete_url');
        $.post(url,{note_id:$(this).parents('li').attr('note_id'),courseid:$('body').attr('courseid')},function(data){

        });
        $(this).parents('li').remove();
    });

});