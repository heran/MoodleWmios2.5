$.extend({
    getUrlVars: function(){
        var vars = [], hash;
        var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
        for(var i = 0; i < hashes.length; i++)
        {
            hash = hashes[i].split('=');
            vars.push(hash[0]);
            vars[hash[0]] = hash[1];
        }
        return vars;
    },
    getUrlVar: function(name){
        return $.getUrlVars()[name];
    }
});

$(document).ready(function(){

    var inModview = false;

    var findOrder = { 
        /**
        * Find the next order
        * 
        * @param modorder
        */
        next : function(modorder){
            var nextorder = modorder+1;
            var maxorder = this.max();
            while(nextorder <= maxorder){
                if($('#curriculum .wrapper>ul>li.popup.mod-view.enabled[modorder="'+nextorder+'"]').length == 0){
                    nextorder += 1;                    
                }else{
                    break;
                }
            }
            if(nextorder > maxorder){
                nextorder = -1;
            }
            return nextorder;
        },

        max : function(){
            var maxorder = 0;
            $('#curriculum .wrapper li[modorder]').each(function(i,n){
                var theOrder = $(this).attr('modorder')-0;
                if(theOrder>maxorder){
                    maxorder = theOrder;
                }
            });
            return maxorder;
        },

        /**
        * Find the prev order
        * 
        * @param modorder
        */
        prev:function(modorder){
            var prevorder = modorder-1;
            while(prevorder>0){
                if($('#curriculum .wrapper>ul>li.popup.mod-view.enabled[modorder="'+prevorder+'"]').length == 0){
                    prevorder -= 1;
                }else{
                    break;
                }
            }
            return prevorder;
        }

    }

    /**
    * Display the mod that has the same modorder
    * 
    * @param modorder
    */
    var displayModByModorder = function(modorder){
        $('#curriculum .wrapper>ul>li.popup.mod-view.enabled[modorder="'+modorder+'"]').click();
        if($('#curriculum .wrapper>ul>li.popup.mod-view.enabled[modorder="'+modorder+'"]').length == 0){
            return false;
        }else{
            return true;
        }
    }

    /**
    * Display the mod that has the same cmid
    * 
    * @param cmid
    */
    var displayModByCmid = function(cmid){
        $('#curriculum .wrapper>ul>li.popup.mod-view.enabled[cmid="'+cmid+'"]').click();
        if($('#curriculum .wrapper>ul>li.popup.mod-view.enabled[cmid="'+cmid+'"]').length==0){
            return false;
        }else{
            return true;
        }
    }

    window.modalUpdateCompletionRatio = function(cmid,ratio){
        $('#curriculum .wrapper>ul>li.popup.mod-view.enabled[cmid="'+cmid+'"] .circle span').css({width:ratio});
    }

    $(document).on('click','#curriculum .wrapper>ul>li.popup.mod-view.enabled',function(event){
        event.preventDefault();
        event.stopPropagation();
        var modname = $(this).attr('modname');
        var cmid = $(this).attr('cmid');
        var url = '/mod/'+modname+'/view.php';
        var param = {id:cmid,wt:'xml'};

        var modorder = $(this).attr('modorder')-0; 

        $('#modal-section-number').html($(this).parent('ul').prev('h5').attr('sectionnumber'));
        $('#modal-lecture-number').html(modorder);
        $('#lecture-handler').attr('modorder',modorder);
        $('#course-taking-page').show().removeClass('off');

        $('#prev-lecture-button').show();
        $('#next-lecture-button').show();
        $('#curriculum>.list').hide();
        $('#region-post').hide();

        $(document).unbind('resumeMod');
        $('#resume-mod').show(); 

        if(modorder<=0){
            return
        }else{   

            //Hide prev button   
            if(findOrder.prev(modorder)<=0){
                $('#prev-lecture-button').hide();
            } 

            //Hide next button
            if(findOrder.next(modorder)<=0){
                $('#next-lecture-button').hide();
            } 

        }

        $.get(url,param,function(data){
            $('#lecture-handler').html(data);
            $('.mod-intro-box').html($('.mod-intro[cmid="'+cmid+'"]').html());
        });

        $(document).trigger('modviewOpen',[{cmid:cmid}]);

        inModview = true;

        return false;
    });

    $(document).on('click','#prev-lecture-button',function(){
        var modorder = $('#lecture-handler').attr('modorder')-0; 
        displayModByModorder(findOrder.prev(modorder));

    });

    $(document).on('click','#next-lecture-button',function(){
        var modorder = $('#lecture-handler').attr('modorder')-0;
        displayModByModorder(findOrder.next(modorder));
    });

    $(document).on('click','#course-taking-page .close-btn',function(){
        $('#course-taking-page').toggleClass('off');
        return false;
    });

    $(document).on('click','#resume-mod',function(){
        $(document).trigger('resumeMod');
        $(this).hide();   
    });

    $(document).on('click','#course-taking-page #go-back',function(){
        $('#lecture-handler').html('');
        $('#course-taking-page').hide();
        $('#curriculum>.list').show();
        $('#region-post').show();
        $(document).trigger('modviewClose');
        inModview = false;
        return false;
    });

    $(document).on('click','#continue-mod-button',function(){
        var cmid = $(this).attr('cmid')-0;
        if(cmid<=0){
            return false;
        }
        return !displayModByCmid(cmid);
    });

    $(document).on('click','.display-by-cmid',function(e){
        if(displayModByCmid($(this).attr('cmid'))){
            e.preventDefault();
            e.stopPropagation();
        }
    });

    //goto and play mod
    $(document).on('click','.goto-and-play-mod',function(e){
        var w = this;
        var cmid = $(this).attr('cmid')-0;
        function play(){
            var type = $(w).attr('modname');
            if(typeof window.gotoAndPlayMod[type] != 'undefined'){
                window.gotoAndPlayMod[type]($(w).attr('position'));
                return true;
            }
            return false;
        }
        if(inModview){
            if(play){
                e.preventDefault();
                e.stopPropagation();
            }
        }else if(cmid){
            if(displayModByCmid(cmid)){
                e.preventDefault();
                e.stopPropagation();
            }
        }

    });




    (function(){
        var cmid = $.getUrlVar('cmid')-0;
        displayModByCmid(cmid);
    })();








});