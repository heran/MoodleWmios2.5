<?php

require(dirname(__FILE__).'/../../config.php');
require_once(dirname(__FILE__).'/locallib.php');
$cmid = required_param('cmid',PARAM_INT);
$cm_context = context::instance_by_id($cmid);

require_capability('mod/document:upload', $cm_context);
$document_base = document_base::instance_from_id($cm_context->instanceid);
$cm = get_coursemodule_from_instance('document', $document_base->id, $document_base->course_id, false, MUST_EXIST);


$PAGE->set_context($cm_context);
$PAGE->set_url($FULLME);
$PAGE->set_cm($cm);
$PAGE->set_pagelayout('noregion');

/** @var mod_document_renderer*/
$renderer = $PAGE->get_renderer('mod_document');

$url_document_base = new moodle_url('/mod/document/view.php?id='.$cmid);

switch(optional_param('action','',PARAM_ACTION))
{
    case 'file':
    {
        $de = new document_entity($document_base);

        $file = $_FILES['Filedata'];

        $data = array();
        $valid = true;
        if($file['error'])
        {
            $valid = false;
            $data['error'] = '传输错误';
        }elseif(!$de->file_size_is_valid(filesize($file['tmp_name'])))
        {
            $data['error'] = '文件大小超过限制:20M';
            $valid = false;
        }elseif(!$de->file_extension_is_valid($file['name']))
        {
            $data['error'] = '文档类型错误';
            $valid = false;
        }
        else{
            try{
                $data['key'] = $de->upload_file($file);
            }catch (Exception $e)
            {
                $valid = false;
                $data['error'] = $e->getMessage();
            }

        }
        $data['status'] = $valid ? 1 : 0;
        echo json_encode($data);

    }
    break;
    case 'edit':
    {
        $key = required_param('key',PARAM_TEXT);
        $de = new document_entity($document_base);
        $de->init_with_key($key);

        $eform = new document_form_entity_edit($document_base,null, $FULLME);

        if ($eform->is_cancelled())
        {
            redirect($url_document_base);
        }
        else if ($data = $eform->get_data())
        {
            $de->setFields($data);
            $de->save();
            redirect($url_document_base.'&key='.$key);
        }
        else
        {
            echo $OUTPUT->header();
            $eform->set_data((object)$de->getFields());
            $eform->display();
            echo $OUTPUT->footer();
        }
    }
    break;
    default:
    {
        $PAGE->requires->js('/mod/document/js/swfobject.js',true);
        echo $OUTPUT->header();
        echo $renderer->render_uploader($cmid);
        echo $OUTPUT->footer();

    }
    break;
}
