<?php
use wmios\survey as survey;
require_once(dirname(__FILE__).'/../../../../config.php');
require_once(dirname(__FILE__).'/lib.php');

/** @var \wmios\survey\activity_wrapper*/
$wrapper = survey\activity_wrapper::instance_from_id(required_param('id',PARAM_INT));

/**
* 获取调查报告
* 
* @var mixed
*/
$url = get_config(SURVEYACTIVITYBASE_PLUGIN_NAME,'uri');
$username = get_config(SURVEYACTIVITYBASE_PLUGIN_NAME,'username');
$password = get_config(SURVEYACTIVITYBASE_PLUGIN_NAME,'password');

$surveyclient = new \survey_client($url,$username,$password);
$surveyid = $wrapper->get_activity_instance()->get_instance()->survey_id;

$doctype = "csv";
$reportstext = $surveyclient->export_results($surveyid,$doctype);
$surveyr_text = base64_decode($reportstext);

$reports=$wrapper->get_activity_instance()->survey_reports($surveyr_text,true);

/**
* 获取报告的信息存到数据库 
*/

/*
foreach($reports as $data)
{
   
  $bool = $wrapper->get_activity_instance()->activity_instance_updates($data);
  if(!$bool)
  {
      throw new \moodle_exception('wrong');
  }
}
*/

/**
* 数据库中某个调查的所有记录
* return array[][]
*/
/*
  $surveyid = $wrapper->get_activity_instance() ->get_instance()->survey_id;    
  $name = "email";
  $values ="sky_2046818@126.com" ;
  $arr = $wrapper->get_activity_instance()->activity_reportsinfo($surveyid,$name,$values);*/
  
/*  
  $rows = array('男','女');
  $name ='gender';
  $surveyid = $wrapper->get_activity_instance() ->get_instance()->survey_id;  
  $arr = $wrapper->get_activity_instance()->activity_reportsinfos($surveyid,$rows,$name);*/
  /*
  $rows = array('dplevel_one','dplevel_two','dplevel_three');
  
  $surveyid = $wrapper->get_activity_instance() ->get_instance()->survey_id;  
  $arr = $wrapper->get_activity_instance()->department_simple($surveyid,$rows);*/
/**
* 计算数据
* 
*/

/*
$a = array();
$b = array();
foreach($arr as $data)
{
    foreach($data as $k=>$v)
    {
        if(in_array('男',$v))
        {
            $a[] = $v ;
        }
        if(in_array('女',$v))
        {
            $b[] = $v;
        }
        
        
    }
    
}
*/

//$results = $wrapper->get_activity_instance()->reports_results($a);

//$res = $wrapper->get_activity_instance()->reports_results($b);


 $surveyid = $wrapper->get_activity_instance() ->get_instance()->survey_id; 
 //$wrapper->get_activity_instance()->departments_results($surveyid);
$rows=array('gender'=>'女');
$arr = $wrapper->get_activity_instance()->surveyreports_results($surveyid,$rows);

$results = $wrapper->get_activity_instance()->reports_results($arr);