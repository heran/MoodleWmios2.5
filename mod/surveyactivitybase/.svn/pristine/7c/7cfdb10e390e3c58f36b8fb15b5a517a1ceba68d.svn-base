<?php
use wmios\survey as survey;
require_once(dirname(__FILE__).'/../../../../config.php');
require_once(dirname(__FILE__).'/lib.php');

$cmid = optional_param('cmid', 0, PARAM_INT); //course module
if(!$cmid)
{
    $cmid = optional_param('id',0, PARAM_INT);
}
if($cmid)
{
    $cm = get_coursemodule_from_id('surveyactivitybase', $cmid);
    $cm_context = context_module::instance($cm->id);
    require_capability('mod/surveyactivitybase:update_activity', $cm_context);
    $sa_base = survey\activity_base::instance_from_id($cm->instance);
}else
{
    $base_id = required_param('base_id',PARAM_INT);
    $sa_base = document_base::instance_from_id($base_id);
    $cm = get_coursemodule_from_instance('surveyactivitybase', $base_id, $sa_base->course_id, false, MUST_EXIST);
    $cm_context = context_module::instance($cm->id);
    require_capability('mod/surveyactivitybase:update_activity', $cm_context);
}
$course = $DB->get_record('course', array('id'=>$cm->course), '*', MUST_EXIST);
require_course_login($course, true, $cm);
$sa_base->set_course($course);
$sa_base->set_cm($cm);
$sa_base->set_context($cm_context);
survey\tool::set_surveyactivity_base($sa_base);

$wrapper = survey\activity_wrapper::instance_from_id(required_param('id',PARAM_INT));

//调查ID
$surveyid = $wrapper->get_activity_instance()->get_instance()->survey_id;

//调查的信息

$jilu = $wrapper->get_activity_instance()->activity_reportsinfo($surveyid);

if(!$jilu)
{
    throw new \moodle_exception('database is wrong');
}


//instance的属性
$strs = new \stdClass();
$strs->startime = $wrapper->starttime;
$strs->endtime = $wrapper->endtime;
$strs->name = $wrapper->name;
$strs->des = $wrapper->description;
$strs->status = $wrapper->status;

//分页
$pagesize = 2;
$num = count($jilu);
$totalpage = ceil($num/$pagesize);

if(isset($_GET['page']))
{
    $currentpage = $_GET['page'];
}else{
    $currentpage = 1; 
}

$offset = ($currentpage-1)*$pagesize;

$rows = $wrapper->get_activity_instance()->activity_page($surveyid,$offset,$pagesize);

if(!$rows)
{
    throw new \moodle_exception('database is wrong');
}

$renderer = $PAGE->get_renderer('surveyactivity_employengage');

echo $renderer->header();

echo $renderer->render_activity_details($rows,$strs,$totalpage);

echo $renderer->footer();