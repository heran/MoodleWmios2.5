<?php

class backup_notes_block_structure_step extends backup_block_structure_step {

    protected function define_structure() {
        global $DB;
        
        //We don't like in mod page.
        //Only when backup a course, we need back the special notes data.
        //When no user info,we need not backup.
        
        /** @var backup_notes_block_task */
        $task = $this->get_task();
        if(!empty($moduleid) || !$task->get_plan_setting_value('users')){
            return parent::define_structure();
        }

        //The notes belong to one course.        
        $notes = new backup_nested_element('notes');
        $note = new backup_nested_element('note', array('id'), array(
            'cmid', 'position', 'userid', 'text', 'modifiedtime'));
        $notes->add_child($note);
        
        $note->set_source_table('notes', array('courseid' => backup::VAR_COURSEID));
        $note->annotate_ids('user', 'userid');
        
        return $this->prepare_block_structure($notes);
    }
}
